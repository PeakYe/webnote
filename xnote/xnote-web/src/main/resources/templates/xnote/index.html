<!DOCTYPE html>
<html>
<head>
<title>${user.name}的笔记本</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<#include "/public/scripts.html" >


<style type="text/css">
	.head-img{ width:100px; border-radius: 50px; margin:15px;}
	.head-text{ color:#fff; font-size:16px;}
	.head-text:HOVER,.head-text:FOCUS { color:#fff; }
	#note-detail{position: absolute; top: 0px; bottom: 0px; right:0px;left:378px;min-width:640px; heightL:100%; overflow: auto; padding-right: 10px;}
/* 	#content img{ max-width: 100%;} */
</style>
</head>
<body>
	<div id="tree"
		style="position: absolute; top: 0px; bottom: 0px; width:374px;">
	</div>
	<div id="note-detail" style="" class="scroll-default">
		 <div id="container" class="hidden">
			<h2 id="title">所有笔记</h2>
			<div class="optbtns">
			    <button id="btnedit" type="button" class="btn btn-link"><i class="glyphicon glyphicon-edit"></i> <span>编辑</span></button>
			    <button id="btndel" type="button" class="btn btn-link"><i class="glyphicon glyphicon-floppy-remove"></i> 删除</button>
			    <button id="btnview" type="button" class="btn btn-link"><span class="glyphicon glyphicon-copyright-mark"></span> 查看</button>
			</div>
			<div id="content" class="markdown-body ">---------</div>
	      </div>
	</div>
	<script type="text/javascript">

		var currentBlog;
		function showContent(id, el) {
			var id=id.split('_')[1];
			c.ajax({
				url : '/service/xnote/detail',
				data : {
					id : id
				},
				success : function(r) {
					var data = r.data;
					currentBlog = data;
					$('#container').removeClass('hidden');
					$('#title').text(data.title);
					$('#content').html(marked(data.content),{renderer:renderer});
					// $(el).addClass('active').siblings().removeClass('active');
				}
			})
		}

		var renderer = new marked.Renderer();
	    renderer.link = function (href,title,text) {
	    	return '<a href="'+href+'" target="_blank">'+text+'</a>';
	    };
		marked.setOptions({
			renderer : renderer,
			gfm : true,
			tables : true,
			breaks : false,
			pedantic : false,
			sanitize : true,
			smartLists : true,
			smartypants : false,
			highlight : function(code) {
				return hljs.highlightAuto(code).value;
			}
		});
		
		$('#btnedit').click(function() {
			//window.open('mkedit.html?xnoteId=' + currentBlog.id);
			editxnote(currentBlog.id);
		})
		$('#btnview').click(function() {
			window.open('/xnote/view/' + currentBlog.id);
		})
		$('#btndel').click(function() {
			layer.confirm('确认删除？', {
				btn : [ '确定', '点错了' ]
			}, function() {
				layer.closeAll();
				c.ajax({
					url : '/service/xnote/delete.req',
					data : {
						id : currentBlog.id
					},
					success : function() {
						$('#container').addClass('hidden');
						menu.deleteMenu(currentBlog.id,function(del){
							toastr.info('已删除笔记');
						});
					},
					complete : function() {
						layer.closeAll();
					}
				})
			})
		})

		function newxnote(group) {
			layer.open({
				type : 2,
				area : [ '97%', '100%' ],
				// fixed: true, //不固定
				// maxmin: true,
				content : '/xnote/mkedit?create=true&group=' + group,
				scrollbar : false,
				offset : 'r',
				title : false,
				closeBtn : 0
				//shadeClose : true
			});
		}
		
		function editxnote(xnoteId) {
			layer.open({
				type : 2,
				area : [ '97%', '100%' ],
				// fixed: true, //不固定
				// maxmin: true,
				content : '/xnote/mkedit?xnoteId='+xnoteId,
				scrollbar : false,
				offset : 'r',
				title : false,
				closeBtn : 0
				//shadeClose : true,
			});
		}

		function newxnoteCallback(id) {
			if(id==null){
				return;
			}
			c.ajax({
				url : '/service/xnote/detail',
				data : {
					id : id
				},
				success : function(r) {
					var data = r.data;
					createNoteMenu(data.id,data.groupId,data.title);
					showContent('f_'+data.id);
				}
			})
		}
		
		function editxnoteCallback(id){
			if(id==null){
				return;
			}
			c.ajax({
				url : '/service/xnote/detail',
				data : {
					id : id
				},
				success : function(r) {
					var data = r.data;
					menu.modifyMenu('f_'+data.id,{
						id:'f_'+data.id,
						parent:data.groupId,
						text:data.title,
						isfolder: false
					})
					//createNoteMenu(data.id,data.groupId,data.title);
					showContent('f_'+data.id);
				}
			})
		}

		function logout() {
			location.href = "/logout";
		}

		var menu;
		function createNoteMenu(id,groupId,title){
			menu.createMenu({
				id:'f_'+id,
				text:title,
				parent:groupId,
				isfolder: false,
				prefix : '<i class="glyphicon glyphicon-file" ></i>',
				click:function(row){
					showContent(this.id);
				}
			});
			//toastr.info('已创建文件夹 “'+title+'”')
		}
		
		c.ajax({
			url : '/service/xnote/group/detaillist.json',
			success : function(r) {
				var firstMenu = {};
				var secondMenu = {};
				//文件夹
				for ( var i in r.data) {
					var d = r.data[i];

					if (!d.parentId) {
						//一级菜单
						firstMenu[d.id] = {
							id : d.id,
							text : d.name
						}
					} else {
						//二级菜单
						secondMenu[d.id] = {
							id : d.id,
							text : d.name,
							parent : d.parentId
						}
					}

					//笔记
					for ( var j in d.notes) {
						var note = d.notes[j];
						var nnode = {
							text : c.escapeHtml(note.title),
							prefix : '<i class="glyphicon glyphicon-file" ></i>',
							parent : note.groupId,
							attrs : {
								'note-id' : note.id
							},
							click:function(row){
								showContent(this.id);
							},
							isfolder: false
						}
						secondMenu['f_'+note.id] = nnode;
					}
				}

// 				console.log(firstMenu);
// 				console.log(secondMenu);

				menu = new FileView({
					contain : '#tree',
					mainHeadHtml : '<img class="head-img" src="/imgs/head.jpg" /><div class="dropdown"><a class="head-text" data-toggle="dropdown" href="#">'+c.escapeHtml(window.localStorage['user-name'])+'</a><ul class="dropdown-menu" role="menu" aria-labelledby="dLabel"> <li><a href="/logout">退出登录</a></li></ul></div>',
					mainMenu : firstMenu
				})
				
				$(".dropdown-toggle").dropdown('toggle');
				menu.addSubMenu(secondMenu);
				
				if(!menu.showDefault()){
					//
				}
				
				menu.sortMenu();
			}
		})

		var menu = new BootstrapMenu('.file-view-main ul,.file-view-main ul li', {
			fetchElementData : function(row) {
				return {
					parent : row.attr('main-menu-id'),
					deletedable : row.attr('deletedable'),
					mainMenuId: row.attr('main-menu-id')
				}
			},

			actions : [ {
				name : '创建文件夹',
				onClick : function(row) {
					
					layer.prompt({title: '文件夹名称', formType: 0, maxlength:20 }, function(text, index){
						layer.close(index);
						c.ajax({
							url : '/service/xnote/group/create.json',
							data : {
								name : text
							},
							success : function(r) {
								var d=r.data;
								menu.createMenu({
							 		id:d.id,
							 		text: d.name,
							 		parent:null
							 	});
							 	toastr.info('已创建文件夹 “'+d.name+'”');
							}
						})
					});
				}
			},{
				name : '删除文件夹',
				onClick : function(row) {
					
					layer.confirm('确认删除？',{
						btn:['是','点错了']
					},function(index){
						c.ajax({
							url : '/service/xnote/group/delete.json',
							data : {
								id : row.mainMenuId
							},
							success : function(r) {
								var d=r.data;
								menu.deleteMenu(r.data);
							}
						});
						layer.close(index);
					});
				},
				isEnabled: function(row) {
			        return row.deletedable==null?true:false;
		    	}
			} ]
		});
				
		var menu = new BootstrapMenu('.sub-menu-ul li,.sub-menu-ul', {
			fetchElementData : function(row) {
				return {
					isfolder: row.attr('isfolder')=='true',
					folderId : row.attr('sub-menu-id'),
					deleteable: !row.hasClass('sub-menu-ul'),
					currentFolder: !(row.hasClass('sub-menu-ul'))?row.parent().attr('sub-menu-id'):row.attr('sub-menu-id')
				}
			},

			actions : [ {
				name : '创建笔记',
				onClick : function(row) {
					if(row.folderId==null){
						layer.alert('需要先选择文件夹')
						return ;
					}
					newxnote(row.currentFolder);
				}
			}, {
				name : '创建文件夹',
				onClick : function(row) {
					layer.prompt({title: '文件夹名称', formType: 0, maxlength:6 }, function(text, index){
						layer.close(index);
						c.ajax({
							url : '/service/xnote/group/create.json',
							data : {
								parentId :row.currentFolder==null?null:row.currentFolder,
								name : text
							},
							success : function(r) {
								var d=r.data;
								menu.createMenu({
							 		id:d.id,
							 		text: d.name,
							 		parent: d.parentId
							 	})
							}
						})
					});
				}
			} ,{
				name : '删除',
				onClick : function(row) {
					if(row.isfolder){
						layer.confirm('确认删除？',{
							btn:['是','点错了']
						},function(index){
							layer.close(index);
							c.ajax({
								url : '/service/xnote/group/delete.json',
								data : {
									id : row.folderId
								},
								success : function(r) {
									var d=r.data;
									menu.deleteMenu(row.folderId,function(del){
										toastr.info('已删除文件夹 “'+del.text+'”')
									});
								}
							});
						});
					}else{
						layer.confirm('确认删除？',{
							btn:['是','点错了']
						},function(index){
							layer.close(index);
							c.ajax({
								url : '/service/xnote/delete.json',
								data : {
									id : row.folderId.split('_')[1]
								},
								success : function(r) {
									var d=r.data;
									menu.deleteMenu(row.folderId,function(del){
										toastr.info('已删除笔记 “'+del.text+'”')
									});
								}
							});
						});
					}
					
				},
				isEnabled: function(row) {
			        return row.deleteable;
		    	}
			}]
		});
		
		
	</script>
</body>
</html>