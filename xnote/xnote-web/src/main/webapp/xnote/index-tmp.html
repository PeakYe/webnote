<!DOCTYPE html>
<html>
    <head>
        <title>主页</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="http://nobibi.site/scripts/bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="http://nobibi.site/scripts/layer/mobile/need/layer.css">
        <link rel="stylesheet" href="http://nobibi.site/scripts/common/common.css">
        <link href="http://nobibi.site/scripts/markdown/markdown.css" rel="stylesheet" />     
        <link href="http://nobibi.site/scripts/highlight/highlight-default.css" rel="stylesheet" />  
        <link rel="stylesheet" type="text/css" href="http://nobibi.site/scripts/bootstrap-treeview/css/bootstrap-treeview.css">
        <!-- <link href="http://nobibi.site/scripts/context/css/context.standalone.css" rel="stylesheet" />   -->

        <script src="http://nobibi.site/scripts/jquery/jquery-2.1.1.min.js"></script>
        <script src="http://nobibi.site/scripts/bootstrap/js/bootstrap.min.js"></script>
        <!-- <script src="http://nobibi.site/scripts/bootstrap/js/bootstrap-contextmenu.js"></script> -->
        <script src="http://nobibi.site/scripts/bootstrap/js/BootstrapMenu.min.js"></script>

        <!-- <script src="http://nobibi.site/scripts/context/js/context.js"></script> -->

        <script src="http://nobibi.site/scripts/common/common.js"></script>

        <script src="http://nobibi.site/scripts/layer/layer.js"></script>

        <script src="http://nobibi.site/scripts/markdown/marked.js"></script>
        <script src="http://nobibi.site/scripts/highlight/highlight.pack.js"></script>
		 <script src="http://nobibi.site/scripts/bootstrap-treeview\js\bootstrap-treeview.js"></script>

        <style type="text/css">
			.optbtns{ border-bottom: 1px solid #ccc; }
			#content{ padding-left: 0px; margin-top: 20px; font-size: 1.6rem;}
			.panel-group .panel+.panel{
				margin-top: 0px;
				border-top: none;
			}
			.panel-group .panel{
				border-radius: 0px; box-shadow: none;
			}
        </style>
	</head>
	<body>
	

		<nav class="navbar navbar-default " role="navigation">
			<div class="container">
		      <div class="col-xs-12 col-sm-8 col-md-8" style="padding-left: 0px;">
		        <ul class="nav navbar-nav" >
		            <li class=""><a href="#"  style="font-size: 2.6rem;margin-left: 0px;padding-left: 0px;">XNote</a></li>
		        </ul>
		      </div>
		      <div class="col-xs-12 col-sm-4 col-md-4 ">
					<ul class="nav navbar-nav pull-right" >
<!-- 						<li id="newxnote" class=""><a href="#" >写笔记</a></li> -->
			            <li class="">
			            	<a  class="dropdown-toggle" data-toggle="dropdown" href="#" ><span id="user"></span><b class="caret"></a></b>
			                <ul class="dropdown-menu">
			                    <li><a href="#">个人中心</a></li>
			                    <li class="divider"></li> 
			                    <li><a href="javascript:logout()">退出登录</a></li>
			                </ul>

			            </li>
			        </ul>
		      </div>
		    </div>
		</nav>

		<div class="container">
		    <div class="row">
		    	<div id="context-menu">
				  <ul class="dropdown-menu" role="menu">
				    <li><a tabindex="-1" href="#">Action</a></li>
				    <li><a tabindex="-1" href="#">Separated link</a></li>
				  </ul>
				</div>
		      <div class="col-xs-12 col-sm-3 col-md-3" id="xnotelist" data-toggle="context"  data-target="#context-menu">
		      	<p class="text-right" style="color:#ccc;">
		      		<!-- <a href="#"><i class="glyphicon glyphicon-resize-vertical"></i></a> -->
		      		<a id="newgroup" href="#" class="text-right" style="color:#ccc;"><i class="glyphicon  glyphicon-folder-open"></i></a>
		      	</p>
		      	<div id="groupinput" class="hidden">
		      		<div class="input-group">
	                    <input type="text" id="newgroup-name" class="form-control">
	                    <span class="input-group-btn">
	                        <button class="btn btn-default" id="newgroup-btn" type="button"><i class="glyphicon glyphicon-saved"></i></button>
	                    </span>
	                </div>
	            </div>
	            <div class="all-note">所有笔记</div>
	            <div id="tree"></div>
				<div class="panel-group" id="accordion"  data-toggle="context">
					
				</div>
			  </div>
		      <div id="container" class="col-xs-12 col-sm-9 col-md-9 hidden">
				<h2 id="title">所有笔记</h2>
				<div class="optbtns">
				    <button id="btnedit" type="button" class="btn btn-link"><i class="glyphicon glyphicon-edit"></i> <span>编辑</span></button>
				    <button id="btndel" type="button" class="btn btn-link"><i class="glyphicon glyphicon-floppy-remove"></i> 删除</button>
				    <button id="btnview" type="button" class="btn btn-link"><span class="glyphicon glyphicon-copyright-mark"></span> 查看</button>
				</div>
				<div id="content"></div>
		      </div>
		    </div>
		     <script type="text/javascript">
		     	$('#user').text(window.localStorage['user-name']);
	     		$('#newxnote').click(function(){
// 	     			c.location.href=('/xnote/mkedit.html')
	     			window.open('mkedit.html');
	     		});
	     		$('#newgroup').click(function(){
	     			$(this).addClass('hidden');
	     			$('#groupinput').removeClass('hidden').blur(function(){
		     			console.log('blur')
		     			$(this).addClass('hidden');
		     			$('#newgroup').removeClass('hidden');
		     		})
	     		});
	     		$('#newgroup-btn').click(function(){
	     			var name=$('#newgroup-name').val();
	     			//TODO
	     		})

	      //   	c.ajax({
	      //   		url:'/service/xnote/listGroup.json',
	      //   		data:{},
	      //   		success:function(r){
	      //   			var list=$('#accordion');
	      //   			var data=r.data;
	      //   			for(i in data){
	      //   				// list.append('<li id="'+data[i].id+'" onclick="showContent('+data[i].id+',this)"><a href="#">'+data[i].title+'</a></li>')
	      //   				// 
	      //   				// list.append('<p><a id="'+data[i].id+'" href="javascript:showContent('+data[i].id+',this)">'+c.escapeHtml(data[i].title)+'</a></p>')
	      //   				var group=data[i];
	      //   				var li='<div class="panel panel-default" floder-id="'+group.id+'">\
							// 				<div class="panel-heading">\
							// 					<h4 class="panel-title">\
							// 							<a data-toggle="collapse" data-parent="#accordion" href="#'+group.id+'">'+group.name+'</a>\
							// 							<a href="javascript:newxnote('+group.id+')" class="pull-right" style="color:#666;"><i class="glyphicon glyphicon-plus"></i></a>\
							// 					</h4>\
							// 				</div>\
							// 				<div id="'+group.id+'" class="panel-collapse collapse in">\
							// 					<div class="panel-body">';
							// if(group.notes!=null){
							// 	for(j in group.notes){
							// 		var note=group.notes[j];
							// 		li+='<p><a id="'+note.id+'" href="javascript:showContent('+note.id+',this)">'+c.escapeHtml(note.title)+'</a></p>';
							// 	}	
							// }
							// li+='</div>\
							// 	</div>';
							// list.append(li);
	      //   			}
	      //   		}
	      //   	})
	        	
	     		var currentBlog;
	        	function showContent(id,el){
	        		c.ajax({
	        			url:'/service/xnote/get',
	        			data:{id:id},
	        			success:function(r){
	        				var data=r.data;
	        				currentBlog=data;
	        				$('#container').removeClass('hidden');
	        				$('#title').text(data.title);
	        				$('#content').html(marked(data.content));
			        		// $(el).addClass('active').siblings().removeClass('active');
	        			}
	        		})
	        	}

	        	marked.setOptions({
	              renderer: new marked.Renderer(),
	              gfm: true,
	              tables: true,
	              breaks: false,
	              pedantic: false,
	              sanitize: true,
	              smartLists: true,
	              smartypants: false,
	              highlight: function (code) {
	                   return hljs.highlightAuto(code).value;
	                  }
	            });
				$('#btnedit').click(function(){
					window.open('mkedit.html?xnoteId='+currentBlog.id);
				})
				$('#btnview').click(function(){
					window.open('../view.html?xnoteId='+currentBlog.id);
				})
				$('#btndel').click(function(){
					layer.confirm('确认删除？',
						{
							btn:['确定','点错了']
						}
						,function(){
							layer.closeAll();
							layer.load();
							c.ajax({
								url:'/service/xnote/delete.req',
								data:{id:currentBlog.id},
								success:function(){
									$('#'+currentBlog.id).remove();
									$('#container').addClass('hidden');
								},
								complete:function(){
									layer.closeAll();
								}
							})
						}
					)
				})
				

				function newxnote(group){
					layer.open({
					  type: 2,
					  area: ['97%', '100%'],
					  // fixed: true, //不固定
					  // maxmin: true,
					  content: 'mkedit.html?group='+group,
					  scrollbar: false,
					  offset: 'r',
					  title: false,
					  closeBtn: 0,
					  shadeClose: true
					});
				}

				function newxnoteCallback(id){
					c.ajax({
	        			url:'/service/xnote/get',
	        			data:{id:id},
	        			success:function(r){
	        				var data=r.data;
	        				currentBlog=data;
	        				$('#container').removeClass('hidden');
	        				$('#title').text(data.title);
	        				$('#content').html(marked(data.content));
			        		// $(el).addClass('active').siblings().removeClass('active');

			        		$('#'+data.groupId+' .panel-body').append('<p><a id="'+data.id+'" href="javascript:showContent('+data.id+',this)">'+data.title+'</a></p>');
	        			}
	        		})
				}

				function logout(){
					c.ajax({
						url:'/service/user/logout',
						success:function(){
							location.href="/user/login.html";
						}
					});
				}


				var nodeMenu={
					node1:{
						pid:null,
						content:'node1'
					},
					node2:{
						pid:'node1',
						content:'node2'

					}
				}

				var nodes={};

				c.ajax({
					url:'/service/xnote/listGroup.json',
					success:function(r){
						//文件夹
						for(var i in r.data){
							var d=r.data[i];
							var node={
								text: c.escapeHtml(d.name),
								nodes:[],
								parentId: d.parentId,
								attrs:{
									'folder-id': d.id
								}
							}
							nodes[d.id]=node;
							if(d.parentId){
								nodes[d.parentId].nodes.push(node);
							}

							//笔记
							for(var j in d.notes){
								var note=d.notes[j];
								var nnode={
									text: c.escapeHtml(note.title),
									attrs:{
										'note-id': note.id
									}
								}
								nodes['n_'+note.id]=nnode;
								nodes[note.groupId].nodes.push(nnode);
							}
						}

						console.log(nodes)

						var tree=new Array();
						for(var i in nodes){
							if(nodes[i].parentId==null){
								tree.push(nodes[i]);
							}
						}
						console.log(tree)
						$('#tree').treeview({
							data:tree
						})
					}
				})

				var menu = new BootstrapMenu('.node-tree ,.all-note', {
				  fetchElementData: function($rowElem) {
				   	 var folderid=$rowElem.attr('folder-id');
				   	 var nodeid=$rowElem.attr('data-nodeid');
				   	 var noteid=$rowElem.attr('note-id');
				   	 return {
				   	 	folderid:folderid,
				   	 	noteid:noteid,
				   	 	nodeid:parseInt(nodeid)
				   	 };
				   	 // return $rowElem.attr('data-nodeid');
				  },

				  actions: [{
				    name: '创建笔记',
				    onClick: function(row) {
				     	newxnote(row);
				    }
				  }, {
				    name: '创建子文件夹',
				    onClick: function(row) {
				    	c.ajax({
		     				url:'/service/xnote/group/create.json',
		     				data:{
		     					parentId: row.folderid,
		     					name: "xxxx"
		     				},
		     				success:function(r){
		     					$('#tree').treeview('addNode',[row.nodeid,{
		     						text:"xxxx"
		     					}])
		     				}
		     			})
				    	
				    }
				  }]
				});

	        </script>
		</body>
</html>